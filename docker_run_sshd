#!/usr/bin/env python3
"""
A script to install and start an SSH daemon in a Docker image, enabling the
user to log on to it.
"""

import argparse
import json
import os
import pwd
import subprocess
import time

class Main(object):
    """
    The main class.
    """

    def __init__(self):
        """
        Parse the command line and set up the class.
        """
        parser = argparse.ArgumentParser(
            description="Install and start an SSH daemon in a Docker image, "
                        "enabling the user to log on to it."
        )
        parser.add_argument('image', metavar='IMAGE')
        parser.add_argument('--privileged',
                            default=False, action='store_true')
        parser.add_argument('-u', '--user', dest='user', default='app',
                            help="The user to enable logging in as")
        default_identity = (subprocess
                            .check_output(['ssh-add', '-L'])
                            .decode()
                            .strip())
        parser.add_argument('-i', '--identity', dest='identity',
                            default=default_identity,
                            help="The SSH key to add")
        parser.add_argument('--host-uid',
                            default=os.getuid(),
                            help="The UID to change the user to")
        parser.add_argument('--mount-root',
                            help="The directory to mount the container root "
                                "on the host (requires sudo)")
        parser.add_argument('--storage',
                            help="The host directory to provide "
                                "to the container as storage volume")

        parser.add_argument('--database-host',
                            default='172.17.42.1',
                            help="The database host to provide "
                                "to the container")
        parser.add_argument('--database-port',
                            default=5432,
                            help="The database host to provide "
                                "to the container")
        parser.add_argument('--database',
                            help="The database name to provide "
                                "to the container")
        parser.add_argument('--database-user',
                            help="The database user to provide "
                                "to the container")
        parser.add_argument('--database-password',
                            help="The database password to provide "
                                "to the container")

        parser.add_argument('--elasticsearch-url',
                            default='http://172.17.42.1:9200/',
                            help="Elasticsearch URL to provide "
                                "to the container")
        parser.add_argument('--elasticsearch-index',
                            help="Elasticsearch index name to provide "
                                "to the container")

        self.args = parser.parse_args()
        self.container = None
        self.container_details = None

        # Backfill for Python < 3.3
        try:
            self.devnull = subprocess.DEVNULL
        except AttributeError:
            self.devnull = open(os.devnull)

    def format_args(self, *items):
        """
        Format each item with values taken from parsed arguments.
        """
        return [item.format(**self.args.__dict__) for item in items]

    def setup_commands(self):
        """
        The commands to install and start an SSH server in a container
        """
        commands = [
            'DEBIAN_FRONTEND=noninteractive apt-get -qq install ssh sudo',
            'invoke-rc.d ssh stop',
            ('echo \'AuthorizedKeysFile /etc/ssh/%u/authorized_keys\' >> ' +
                '/etc/ssh/sshd_config'),
            'echo \'PermitUserEnvironment yes\' >> /etc/ssh/sshd_config',
        ] + [
            'echo \'{0}={1}\' >> /etc/environment'.format(*env)
            for env in self.environment().items()
        ] + [
            'mkdir -p /etc/ssh/{user}',
            'echo \'{identity}\' > /etc/ssh/{user}/authorized_keys',
            'chsh -s /bin/bash {user}',
            'usermod -p zzz {user}',
            'chown -R --from={user} {host_uid} /app',
            'usermod -u {host_uid} {user}',
            'chown -R {user} /etc/ssh/{user}',
            'chmod -R go-rwx /etc/ssh/{user}',
            'echo \'{user} ALL=(ALL) NOPASSWD: ALL\' >> /etc/sudoers',
            '/usr/sbin/sshd -D',
        ]
        return '&&'.join(self.format_args(*commands))

    def environment(self):
        """
        The environment to set in the container
        """
        env = {}

        env['ENVIRONMENT'] = 'dev_local'
        env['DEVNAME'] = pwd.getpwuid(os.getuid())[0]

        # TODO: SITE_DOMAIN, SITE_PROTOCOL

        if self.args.database:
            env['DB_DEFAULT_TYPE'] = 'postgres'
            env['DB_DEFAULT_HOST'] = self.args.database_host
            env['DB_DEFAULT_PORT'] = self.args.database_port
            env['DB_DEFAULT_NAME'] = self.args.database
            env['DB_DEFAULT_USER'] = self.args.database_user
            env['DB_DEFAULT_PASSWORD'] = self.args.database_password

        # TODO: TZ

        # TODO: EMAIL_HOST, EMAIL_PORT

        if self.args.elasticsearch_index:
            env['ELASTICSEARCH_URLS'] = self.args.elasticsearch_url
            env['ELASTICSEARCH_INDEX_NAME'] = self.args.elasticsearch_index

        # TODO: SYSLOG_SERVER, SYSLOG_PORT, SYSLOG_PROTO

        return env

    def container_command(self):
        """
        The command to run the container
        """
        docker_command = [
            'docker', 'run',
            '-d',
            '-P',
            '-p', '22',
            '--entrypoint=/bin/bash',
            '-u=root',
        ]
        if self.args.privileged:
            docker_command += [
                '-privileged',
            ]
        if self.args.storage:
            subprocess.check_call(['mkdir', '-p', self.args.storage])
            docker_command += [
                '-v', '{storage}:/storage',
            ]
        docker_command += [
            '{image}',
            '-c', self.setup_commands(),
        ]
        return self.format_args(*docker_command)

    def start_container(self):
        """
        Start the container with the SSH daemon inside.
        """
        command = self.container_command()
        self.container = subprocess.check_output(command).strip()
        self.container_details = json.loads(
            subprocess.check_output(
                ['docker', 'inspect', self.container]
            ).decode()
        )[0]

    def mount_root(self):
        """
        Mount the container's root directory on the host.
        """

        # If requested, mount the working directory
        if self.args.mount_root:
            mount_root = self.args.mount_root

            subprocess.call(['sudo', 'umount', mount_root],
                            stderr=self.devnull)
            subprocess.check_call(['mkdir', '-p', mount_root])

            driver = self.container_details['Driver']
            rootfs_path = \
                '/var/lib/docker/{driver}/mnt/{container}'.format(
                    driver=driver,
                    container=self.container.decode(),
                )

            # AUFS and DeviceMapper use different paths
            if driver == 'devicemapper':
                rootfs_path += '/rootfs'

            subprocess.check_call(['sudo', 'mount', '-o', 'bind',
                                rootfs_path,
                                mount_root])
            print("Container filesystem mounted on {mount_root}".format(
                mount_root=mount_root))


    def print_ssh_details(self):
        """
        Wait for SSH service to start and print the command to SSH to
        the container.
        """

        ssh_port = self.container_details['HostConfig']['PortBindings']\
            ['22/tcp'][0]['HostPort']
        ssh_command = self.format_args(
            'ssh',
            '{user}@localhost',
            '-p',
            ssh_port,
        )
        for _ in range(1, 10):
            try:
                subprocess.check_call(
                    ssh_command + ['-o', 'StrictHostKeyChecking=no',
                                '-o', 'PasswordAuthentication=no',
                                'true'],
                    stdin=self.devnull,
                    stdout=self.devnull,
                    stderr=self.devnull,
                )
                print(' '.join(ssh_command))
                return
            except subprocess.CalledProcessError:
                pass
            time.sleep(1)

    def main(self):
        """
        Run the container with SSH set up.
        """
        self.start_container()
        self.mount_root()
        self.print_ssh_details()

if __name__ == '__main__':
    Main().main()
